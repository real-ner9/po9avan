<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>po9avan WebApp</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; margin: 0; padding: 16px; }
      .container { max-width: 720px; margin: 0 auto; }
      select, button { font-size: 16px; padding: 10px; margin: 8px 0; width: 100%; }
      .row { display: flex; gap: 12px; }
      .col { flex: 1; }
      .card { border: 1px solid #e5e5e5; border-radius: 10px; padding: 12px; margin-top: 8px; }
      .muted { color: #666; font-size: 14px; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <div class="container">
      <h2>Твой профиль</h2>
      <div>
        <label>Твоя профессия</label>
        <select id="profession"></select>
      </div>
      <div>
        <label>Кого ты ищешь</label>
        <select id="lookingFor" multiple size="6"></select>
        <div class="muted">Зажми Cmd/Ctrl для выбора нескольких</div>
      </div>
      <button id="saveBtn">Сохранить профиль</button>
      <hr />
      <h2>Поиск менторов/учеников</h2>
      <div class="row">
        <div class="col">
          <label>Кого ищут твоей профессии</label>
          <select id="searchProfession"></select>
        </div>
      </div>
      <button id="searchBtn">Найти</button>
      <div id="results"></div>
    </div>

    <script>
      const tg = window.Telegram?.WebApp;
      tg?.expand();
      const initData = tg?.initData || '';
      const headers = { 'Content-Type': 'application/json', 'x-telegram-init-data': initData };

      const professionSelect = document.getElementById('profession');
      const lookingForSelect = document.getElementById('lookingFor');
      const searchProfessionSelect = document.getElementById('searchProfession');
      const resultsDiv = document.getElementById('results');

      async function getJSON(url) {
        const res = await fetch(url, { headers });
        return res.json();
      }

      function setOptions(select, options) {
        select.innerHTML = '';
        for (const opt of options) {
          const o = document.createElement('option');
          o.value = opt; o.textContent = opt; select.appendChild(o);
        }
      }

      async function bootstrap() {
        const professions = await getJSON('/api/users/professions');
        setOptions(professionSelect, [''].concat(professions));
        setOptions(searchProfessionSelect, professions);
        setOptions(lookingForSelect, professions);

        const me = await getJSON('/api/users/me');
        if (me) {
          if (me.profession) professionSelect.value = me.profession;
          if (Array.isArray(me.lookingFor)) {
            for (const option of lookingForSelect.options) {
              option.selected = me.lookingFor.includes(option.value);
            }
          }
        }
      }

      document.getElementById('saveBtn').addEventListener('click', async () => {
        const looking = Array.from(lookingForSelect.selectedOptions).map(o => o.value);
        const body = { profession: professionSelect.value || undefined, lookingFor: looking };
        await fetch('/api/users/me', { method: 'POST', headers, body: JSON.stringify(body) });
        tg?.showPopup({ title: 'Сохранено', message: 'Профиль обновлён' });
      });

      document.getElementById('searchBtn').addEventListener('click', async () => {
        const prof = searchProfessionSelect.value;
        const found = await getJSON('/api/users/search?profession=' + encodeURIComponent(prof));
        resultsDiv.innerHTML = '';
        if (!found?.length) {
          resultsDiv.textContent = 'Никто пока не ищет эту профессию';
          return;
        }
        for (const u of found) {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `<b>${u.firstName}${u.lastName ? ' ' + u.lastName : ''}</b>
            <div class="muted">@${u.username || 'no_username'} · ищет: ${(u.lookingFor||[]).join(', ')}</div>
            <button>Смэтчиться</button>`;
          const btn = card.querySelector('button');
          btn.addEventListener('click', async () => {
            await fetch('/api/matches', {
              method: 'POST',
              headers,
              body: JSON.stringify({ targetTelegramId: u.telegramId, profession: prof }),
            });
            tg?.showPopup({ title: 'Готово', message: 'Матч создан! Напиши ему в Telegram.' });
          });
          resultsDiv.appendChild(card);
        }
      });

      bootstrap();
    </script>
  </body>
  </html>


